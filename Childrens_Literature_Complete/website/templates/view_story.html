{% extends "base.html" %}

{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<div class="view-story">

    <!-- Model Indicator at Top -->
    <div id="model-symbol" style="text-align:center; margin-top:20px; font-size:2em;">
        {% if model_choice == 'b' %}
            ‚≠ê
        {% else %}
            üíú
        {% endif %}
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" style="text-align:center; margin-top:50px;">
        <h1>‚ú® Generating your story... please wait this may take a few minutes ‚ú®</h1>
        <p id="model-indicator" style="color:#666; margin-top:10px;"></p>
        <div class="spinner" style="margin-top:30px;">
            <div class="loader"></div>
        </div>
    </div>

    <!-- Story Content -->
    <div id="story-content" style="display:none; max-width:900px; margin:0 auto;">
        <h1 style="text-align:center; margin-bottom:30px;">Your Story</h1>

        <div id="story-sections"></div>

        <!-- Download PDF -->
        <div style="text-align:center; margin-top:40px;">
            <button onclick="printStory()"
                    style="background:#28a745; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;">
                üìÑ Download PDF
            </button>
        </div>
    </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const storyPrompt = "{{ final_prompt }}";
    const userId = "{{ request.args.get('user_id') }}";
    const promptId = "{{ request.args.get('prompt_id') }}";
    const modelChoice = "{{ model_choice|default('a') }}";
    const modelSymbol = document.getElementById("model-symbol");

    // Update the small indicator under the loading text
    const modelIndicator = document.getElementById("model-indicator");
    modelIndicator.textContent = modelChoice === 'b' ? "‚≠ê Model B is generating your story" : "üíú Model A is generating your story";

    // Keep symbol at top synced with loading
    modelSymbol.textContent = modelChoice === 'b' ? "‚≠ê" : "üíú";

    // Fetch the story from the API
    fetch(`/generate_story_api?prompt=${encodeURIComponent(storyPrompt)}&user_id=${userId}&prompt_id=${promptId}&model=${modelChoice}`)
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            document.getElementById("loading-screen").style.display = "none";
            document.getElementById("story-content").style.display = "block";

            // Update top model symbol for the generated story
            modelSymbol.textContent = data.model_used === 'b' ? "‚≠ê" : "üíú";

            displayStoryWithImages(data.story, data.images || []);
        })
        .catch(err => {
            console.error("Error:", err);
            document.getElementById("loading-screen").innerHTML = `
                <div style="background:#f8d7da; color:#721c24; padding:30px; border-radius:10px; max-width:600px; margin:0 auto;">
                    <h2>‚ö†Ô∏è Something went wrong</h2>
                    <p>There was an error generating your story.</p>
                    <div style="margin-top:20px;">
                        <button onclick="window.location.reload()" style="background:#dc3545; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; margin-right:10px;">Try Again</button>
                        <a href="/create_story?user_id=${userId}" style="background:#6c757d; color:white; padding:10px 20px; border-radius:5px; text-decoration:none;">Go Back</a>
                    </div>
                </div>
            `;
        });
});

function displayStoryWithImages(storyText, images) {
    const container = document.getElementById("story-sections");

    if (!storyText || storyText.trim().length === 0) {
        container.innerHTML = `
            <div style="text-align:center; padding:40px; color:#666;">
                <h3>No story was generated</h3>
                <p>Please try creating a new story.</p>
            </div>
        `;
        return;
    }

    storyText = storyText.trim();
    if (!storyText.endsWith("The End.")) storyText += "\n\nThe End.";

    const paragraphs = storyText.split(/\n\s*\n/).map(p => p.trim()).filter(p => p.length > 0);
    let storyParts = ["", "", ""];
    if (paragraphs.length >= 3) {
        const third = Math.floor(paragraphs.length / 3);
        storyParts[0] = paragraphs.slice(0, third).join("\n\n");
        storyParts[1] = paragraphs.slice(third, 2*third).join("\n\n");
        storyParts[2] = paragraphs.slice(2*third).join("\n\n");
    } else {
        storyParts = paragraphs.concat(["", "", ""]).slice(0,3);
    }

    const sections = ["Beginning", "Middle", "End"];
    container.innerHTML = "";

    sections.forEach((title, idx) => {
        const text = storyParts[idx].trim();
        if (!text) return;
        const img = images[idx] || "/static/fallback_image.png";
        const div = document.createElement("div");
        div.className = "story-section";
        div.innerHTML = `
            <div class="image-container">
                <img src="${img}" alt="${title}" class="story-image">
                <div class="image-caption">${title} of the story</div>
            </div>
            <div class="story-text-container">
                <h3>${title}</h3>
                <p>${text}</p>
            </div>
        `;
        container.appendChild(div);
    });
}

function printStory() {
    document.getElementById('story-content').style.display = 'block';
    window.print();
}
</script>
{% endblock %}
